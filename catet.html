<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catet!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-[#F8FAFB] pb-40"> 
    
    <header class="p-8 bg-[#005461] text-white rounded-b-[3.5rem] shadow-xl relative z-20">
        <button onclick="location.href='index.html'" class="mb-4 opacity-70 text-sm italic"><i class="fas fa-arrow-left mr-2"></i> Kembali</button>
        <h1 class="text-2xl font-black tracking-tighter uppercase">CATET!<span class="text-[#00B7B5]">!</span></h1>
        <p class="text-[10px] font-bold text-[#00B7B5] uppercase tracking-[0.2em] opacity-80">Biar ga kaget pas dompet seret.</p>
    </header>

    <main class="p-6 -mt-6 relative z-30">
        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-slate-100 mb-6 text-center">
            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Pengeluaran</p>
            <h2 id="total-pengeluaran" class="text-3xl font-black text-[#005461] tracking-tighter">Rp 0</h2>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100 mb-6 space-y-3">
            <h3 class="text-[10px] font-black text-[#00B7B5] uppercase px-2">Tambah Baru</h3>
            <input type="text" id="catet-item" placeholder="Beli apa hari ini?" class="w-full px-5 py-3 bg-[#F4F4F4] rounded-2xl text-sm font-bold border-none focus:ring-2 focus:ring-[#00B7B5]">
            <input type="number" id="catet-nominal" placeholder="Nominal (Contoh: 50000)" class="w-full px-5 py-3 bg-[#F4F4F4] rounded-2xl text-sm font-bold border-none focus:ring-2 focus:ring-[#00B7B5]">
            <input type="date" id="catet-tgl" class="w-full px-5 py-3 bg-[#F4F4F4] rounded-2xl text-sm font-bold border-none focus:ring-2 focus:ring-[#00B7B5]">
            <button onclick="simpanCatatan()" class="w-full bg-[#005461] text-white font-black py-4 rounded-2xl shadow-lg uppercase text-xs active:scale-95 transition-all">Simpan Catatan</button>
        </div>

        <div class="flex items-center gap-2 mb-4 px-2">
            <div class="flex-1 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                <p class="text-[8px] font-black text-slate-400 uppercase ml-2">Mulai</p>
                <input type="date" id="filter-start" onchange="loadCatatan()" class="w-full bg-transparent text-[10px] font-bold border-none focus:ring-0">
            </div>
            <div class="flex-1 bg-white p-2 rounded-xl shadow-sm border border-slate-100">
                <p class="text-[8px] font-black text-slate-400 uppercase ml-2">Sampai</p>
                <input type="date" id="filter-end" onchange="loadCatatan()" class="w-full bg-transparent text-[10px] font-bold border-none focus:ring-0">
            </div>
        </div>

        <div id="list-catetan" class="space-y-3">
            </div>
    </main>

    <section class="grid grid-cols-4 gap-2 px-8 mt-10 opacity-60">
        <a href="keuangan.html" class="flex flex-col items-center"><div class="w-10 h-10 bg-slate-200 rounded-2xl flex items-center justify-center mb-1"><i class="fas fa-wallet text-[#005461] text-xs"></i></div></a>
        <a href="lapor.html" class="flex flex-col items-center"><div class="w-10 h-10 bg-slate-200 rounded-2xl flex items-center justify-center mb-1"><i class="fas fa-bullhorn text-[#005461] text-xs"></i></div></a>
        <a href="pengurus.html" class="flex flex-col items-center"><div class="w-10 h-10 bg-slate-200 rounded-2xl flex items-center justify-center mb-1"><i class="fas fa-users-cog text-[#005461] text-xs"></i></div></a>
        <a href="lapak.html" class="flex flex-col items-center"><div class="w-10 h-10 bg-slate-200 rounded-2xl flex items-center justify-center mb-1"><i class="fas fa-store text-[#005461] text-xs"></i></div></a>
    </section>

    <div class="fixed bottom-6 left-0 right-0 px-8 z-50">
        <nav class="bg-[#005461]/95 backdrop-blur-xl p-3 rounded-full flex justify-between items-center shadow-2xl border border-white/10">
            <button onclick="location.href='index.html'" class="w-12 h-12 flex items-center justify-center text-[#00B7B5] bg-white rounded-full shadow-lg">
                <i class="fas fa-home text-lg"></i>
            </button>
            <button onclick="handleLogout()" class="flex items-center gap-3 bg-white/10 px-6 py-2 rounded-full text-white">
                <i class="fas fa-user-circle text-lg text-[#00B7B5]"></i>
                <span id="user-display" class="text-[10px] font-black uppercase tracking-widest">Warga</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD7rGI9iL0M889t6PR8za1-PxvjA_6jdHQ",
            authDomain: "websekawan.firebaseapp.com",
            projectId: "websekawan",
            databaseURL: "https://websekawan-default-rtdb.asia-southeast1.firebasedatabase.app/",
            appId: "1:407413490869:web:093f8a187261c68ea36afc"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- CEK LOGIN ---
        const userHp = localStorage.getItem('userHp');
        const userNama = localStorage.getItem('userNama') || 'Warga';
        
        if(!userHp) {
            alert("Halaman khusus warga! Login dulu, bro.");
            location.href = 'login.html';
        }

        document.getElementById('user-display').innerText = userNama.split(' ')[0];
        document.getElementById('catet-tgl').valueAsDate = new Date();

        // --- SIMPAN ---
        window.simpanCatatan = () => {
            const item = document.getElementById('catet-item').value;
            const nominal = document.getElementById('catet-nominal').value;
            const tgl = document.getElementById('catet-tgl').value;

            if(item && nominal && tgl) {
                push(ref(db, `catet/${userHp}`), {
                    item, 
                    nominal: parseInt(nominal), 
                    tgl,
                    createdAt: Date.now()
                }).then(() => {
                    document.getElementById('catet-item').value = "";
                    document.getElementById('catet-nominal').value = "";
                });
            } else {
                alert("Isi semua dulu dong, bro!");
            }
        };

        // --- LOAD DATA ---
        window.loadCatatan = () => {
            const start = document.getElementById('filter-start').value;
            const end = document.getElementById('filter-end').value;
            
            onValue(ref(db, `catet/${userHp}`), (snap) => {
                const list = document.getElementById('list-catetan');
                let html = "";
                let total = 0;
                
                if(snap.exists()) {
                    let dataArray = [];
                    snap.forEach(child => {
                        let item = child.val();
                        item.key = child.key;
                        
                        // Filter Logika
                        if(start && item.tgl < start) return;
                        if(end && item.tgl > end) return;
                        
                        dataArray.push(item);
                    });

                    // Urutkan Tanggal Terbaru
                    dataArray.sort((a,b) => new Date(b.tgl) - new Date(a.tgl));

                    dataArray.forEach(d => {
                        total += d.nominal;
                        html += `
                            <div class="bg-white p-4 rounded-3xl border border-slate-50 shadow-sm flex justify-between items-center border-l-4 border-l-[#00B7B5]">
                                <div>
                                    <p class="text-[8px] font-black text-slate-400 uppercase">${d.tgl}</p>
                                    <h4 class="text-xs font-black text-[#005461] uppercase">${d.item}</h4>
                                    <p class="text-sm font-black text-[#00B7B5]">Rp ${d.nominal.toLocaleString('id-ID')}</p>
                                </div>
                                <button onclick="hapusCatet('${d.key}')" class="w-8 h-8 flex items-center justify-center text-red-200 hover:text-red-500 transition-colors">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                            </div>
                        `;
                    });
                } else {
                    html = `<div class="text-center py-10 opacity-30 italic text-xs">Belum ada catatan...</div>`;
                }

                list.innerHTML = html;
                document.getElementById('total-pengeluaran').innerText = 'Rp ' + total.toLocaleString('id-ID');
            });
        };

        window.hapusCatet = (key) => {
            if(confirm("Hapus catatan ini?")) {
                remove(ref(db, `catet/${userHp}/${key}`));
            }
        };

        window.handleLogout = () => {
            if(confirm("Mau logout?")) {
                localStorage.clear();
                location.href = 'index.html';
            }
        };

        // Jalankan load pertama kali
        window.onload = () => loadCatatan();
    </script>
</body>
</html>
